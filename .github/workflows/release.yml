name: release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      bootstrap_winget:
        description: "Create/Bootstrap the winget package (first time only)"
        type: boolean
        default: false

jobs:
  build-linux:
    name: build linux (${{ matrix.rid }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [linux-x64, linux-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          { cp LICENSE package/podliner/ 2>/dev/null || true; }
          { cp README.md package/podliner/ 2>/dev/null || true; }
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  build-windows:
    name: build windows (win-x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish (self-contained)
        shell: pwsh
        run: >
          dotnet publish .\StuiPodcast.App\StuiPodcast.App.csproj
          -c Release -r win-x64
          -p:SelfContained=true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:DebugType=None
          -p:Version=${{ steps.meta.outputs.version }}
          -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }}
          -o publish\win-x64

      - name: Prepare dist (zip + exe)
        shell: pwsh
        run: |
          New-Item -Type Directory package\podliner | Out-Null
          Copy-Item publish\win-x64\StuiPodcast.App.exe package\podliner\podliner.exe
          If (Test-Path LICENSE) { Copy-Item LICENSE package\podliner\ }
          If (Test-Path README.md) { Copy-Item README.md package\podliner\ }
          Compress-Archive -Path package\podliner\* -DestinationPath dist\podliner-win-x64.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podliner-win-x64-bundle
          path: |
            dist/podliner-win-x64.zip
            dist/podliner-win-x64.exe

  build-macos:
    name: build macOS (${{ matrix.rid }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [osx-x64, osx-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          { cp LICENSE package/podliner/ 2>/dev/null || true; }
          { cp README.md package/podliner/ 2>/dev/null || true; }
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  publish:
    name: publish release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: gathered

      - name: Gather into dist/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find gathered -type f -name 'podliner-*' -exec cp {} dist/ \;
          { cp scripts/install.ps1      dist/install.ps1      2>/dev/null || true; }
          { cp scripts/install.sh       dist/install.sh       2>/dev/null || true; }
          { cp scripts/install-macos.sh dist/install-macos.sh 2>/dev/null || true; }

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Ensure GitHub Release exists
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
          VER: ${{ steps.meta.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail
          PRE=""
          if [[ "$TAG" == *-rc* || "$TAG" == *-beta* ]]; then
            PRE="--prerelease"
          fi
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "podliner ${VER}" --generate-notes $PRE
          fi

      - name: Guard assets must not already exist
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          names=(
            podliner-linux-x64.tar.gz
            podliner-linux-arm64.tar.gz
            podliner-osx-x64.tar.gz
            podliner-osx-arm64.tar.gz
            podliner-win-x64.zip
            podliner-win-x64.exe
            install.sh
            install.ps1
            install-macos.sh
            SHA256SUMS
          )
          existing="$(gh release view "$TAG" --json assets --jq '.assets[].name' || true)"
          for f in "${names[@]}"; do
            if grep -qx "$f" <<<"$existing"; then
              echo "Asset $f exists on release $TAG. Refusing to overwrite." >&2
              exit 1
            fi
          done

      - name: Upload assets to GitHub Release (no clobber, with retry)
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          upload() {
            gh release upload "$TAG" \
              dist/podliner-linux-x64.tar.gz \
              dist/podliner-linux-arm64.tar.gz \
              dist/podliner-osx-x64.tar.gz \
              dist/podliner-osx-arm64.tar.gz \
              dist/podliner-win-x64.zip \
              dist/podliner-win-x64.exe \
              dist/install.sh \
              dist/install.ps1 \
              dist/install-macos.sh \
              dist/SHA256SUMS
          }
          for i in 1 2 3; do
            if upload; then
              echo "Assets uploaded."
              exit 0
            fi
            echo "Release upload failed (attempt $i). Retrying..."
            sleep $((5 * i))
          done
          echo "Release upload failed after retries." >&2
          exit 1

      - name: Verify uploaded assets match SHA256SUMS
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/release-verify
          gh release download "$TAG" -D /tmp/release-verify
          ( cd /tmp/release-verify && sha256sum -c SHA256SUMS )

  # --------- OPTIONAL: first-time creation of the winget package ----------
  winget-bootstrap:
    name: bootstrap winget (one-time)
    runs-on: windows-latest
    needs: publish
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.bootstrap_winget }}
    steps:
      - name: Determine version + exe URL (latest tag)
        id: meta
        shell: pwsh
        run: |
          $repo = "${{ github.repository }}"
          $hdr  = @{ Authorization = "token ${{ github.token }}" }
          $rel  = Invoke-RestMethod -Headers $hdr -Uri "https://api.github.com/repos/$repo/releases/latest"
          $tag  = $rel.tag_name
          if (-not $tag) { throw "Could not get latest release tag." }
          $ver  = $tag.TrimStart('v')
          $exe  = "https://github.com/$repo/releases/download/$tag/podliner-win-x64.exe"
          "tag=$tag"    | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$ver"| Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "exeurl=$exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Submit to winget-pkgs (creates PR)
        uses: microsoft/winget-create@v1
        with:
          token: ${{ secrets.WINGET_GITHUB_TOKEN }}
          urls: |
            ${{ steps.meta.outputs.exeurl }}
          package_identifier: TimKicker.Podliner
          package_version: ${{ steps.meta.outputs.version }}
          package_name: Podliner
          publisher: TimKicker
          short_description: Terminal-based podcast player (TUI).
          license: MIT

  # --------- Regular winget update after each release tag ----------
  submit-to-winget:
    name: submit to winget
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Tag â†’ version
        id: meta
        shell: bash
        run: |
          TAG="${GITHUB_REF##*/}"; echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Winget Releaser (updates existing package)
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: TimKicker.Podliner
          version: ${{ steps.meta.outputs.version }}
          token: ${{ secrets.WINGET_GITHUB_TOKEN }}
          installers-regex: '\.(exe|msi|msix|appx)(bundle)?$'
          release-repository: ${{ github.repository }}
          release-tag: ${{ github.ref_name }}
          fork-user: timkicker
