name: release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      bootstrap_winget:
        description: "Create/Bootstrap the winget package (first time only)"
        type: boolean
        default: false

jobs:
  build-linux:
    name: build linux (${{ matrix.rid }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [linux-x64, linux-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          { cp LICENSE package/podliner/ 2>/dev/null || true; }
          { cp README.md package/podliner/ 2>/dev/null || true; }
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  build-windows:
    name: build windows (win-x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish (self-contained)
        shell: pwsh
        run: >
          dotnet publish .\StuiPodcast.App\StuiPodcast.App.csproj
          -c Release -r win-x64
          -p:SelfContained=true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:DebugType=None
          -p:Version=${{ steps.meta.outputs.version }}
          -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }}
          -o publish\win-x64

      - name: Prepare dist (zip + exe)
        shell: pwsh
        run: |
          New-Item -Type Directory -Path dist -Force | Out-Null
          New-Item -Type Directory -Path package\podliner -Force | Out-Null

          # Raw exe for winget + Release-Asset
          Copy-Item publish\win-x64\StuiPodcast.App.exe dist\podliner-win-x64.exe

          # Optionales Zip (exe + Lizenz/Readme)
          Copy-Item publish\win-x64\StuiPodcast.App.exe package\podliner\podliner.exe
          if (Test-Path LICENSE) { Copy-Item LICENSE package\podliner\ }
          if (Test-Path README.md) { Copy-Item README.md package\podliner\ }
          Compress-Archive -Path package\podliner\* -DestinationPath dist\podliner-win-x64.zip -Force


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: podliner-win-x64-bundle
          path: |
            dist/podliner-win-x64.zip
            dist/podliner-win-x64.exe

  build-macos:
    name: build macOS (${{ matrix.rid }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [osx-x64, osx-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          { cp LICENSE package/podliner/ 2>/dev/null || true; }
          { cp README.md package/podliner/ 2>/dev/null || true; }
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  publish:
    name: publish release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: gathered

      - name: Gather into dist/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find gathered -type f -name 'podliner-*' -exec cp {} dist/ \;
          { cp scripts/install.ps1      dist/install.ps1      2>/dev/null || true; }
          { cp scripts/install.sh       dist/install.sh       2>/dev/null || true; }
          { cp scripts/install-macos.sh dist/install-macos.sh 2>/dev/null || true; }

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Ensure GitHub Release exists
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
          VER: ${{ steps.meta.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail
          PRE=""
          if [[ "$TAG" == *-rc* || "$TAG" == *-beta* ]]; then
            PRE="--prerelease"
          fi
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" --title "podliner ${VER}" --generate-notes $PRE
          fi

      - name: Guard assets must not already exist
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          names=(
            podliner-linux-x64.tar.gz
            podliner-linux-arm64.tar.gz
            podliner-osx-x64.tar.gz
            podliner-osx-arm64.tar.gz
            podliner-win-x64.zip
            podliner-win-x64.exe
            install.sh
            install.ps1
            install-macos.sh
            SHA256SUMS
          )
          existing="$(gh release view "$TAG" --json assets --jq '.assets[].name' || true)"
          for f in "${names[@]}"; do
            if grep -qx "$f" <<<"$existing"; then
              echo "Asset $f exists on release $TAG. Refusing to overwrite." >&2
              exit 1
            fi
          done

      - name: Upload assets to GitHub Release (no clobber, with retry)
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          upload() {
            gh release upload "$TAG" \
              dist/podliner-linux-x64.tar.gz \
              dist/podliner-linux-arm64.tar.gz \
              dist/podliner-osx-x64.tar.gz \
              dist/podliner-osx-arm64.tar.gz \
              dist/podliner-win-x64.zip \
              dist/podliner-win-x64.exe \
              dist/install.sh \
              dist/install.ps1 \
              dist/install-macos.sh \
              dist/SHA256SUMS
          }
          for i in 1 2 3; do
            if upload; then
              echo "Assets uploaded."
              exit 0
            fi
            echo "Release upload failed (attempt $i). Retrying..."
            sleep $((5 * i))
          done
          echo "Release upload failed after retries." >&2
          exit 1

      - name: Verify uploaded assets match SHA256SUMS
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/release-verify
          gh release download "$TAG" -D /tmp/release-verify
          ( cd /tmp/release-verify && sha256sum -c SHA256SUMS )


  aur_publish:
    name: submit AUR
    needs: publish
    runs-on: ubuntu-latest
    container:
      image: archlinux:base
    env:
      AUR_PACKAGE: podliner-bin
      AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
      AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
      AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
    steps:
      - name: Install tooling
        run: |
          pacman -Sy --noconfirm git base-devel curl jq pacman-contrib openssh
          git config --global user.name  "${AUR_USERNAME:-podliner-bot}"
          git config --global user.email "${AUR_EMAIL:-actions@users.noreply.github.com}"

      - name: Setup SSH for AUR (root home)
        run: |
          set -euo pipefail
          install -d -m 700 /root/.ssh
          [ -n "${AUR_SSH_PRIVATE_KEY}" ] || { echo "AUR_SSH_PRIVATE_KEY is empty (missing secret?)" >&2; exit 1; }
          printf "%s\n" "$AUR_SSH_PRIVATE_KEY" > /root/.ssh/aur
          chmod 600 /root/.ssh/aur
          cat > /root/.ssh/config <<'EOF'
          Host aur.archlinux.org
            User aur
            IdentityFile /root/.ssh/aur
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
          EOF
          chmod 600 /root/.ssh/config
          ssh -F /root/.ssh/config -o BatchMode=yes -T aur@aur.archlinux.org || true

      - name: Read release info (robust tag detection)
        id: rel
        env:
          GH_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${GITHUB_REF_NAME}"
          
          # For tag workflows, GITHUB_REF_NAME is the tag. Fallback to git when re-running manually.
          if [[ "${tag}" != v* ]]; then
            tag="$(git describe --tags --abbrev=0)"
          fi
          
          ver="${tag#v}"
          x64_url="https://github.com/${repo}/releases/download/${tag}/podliner-linux-x64.tar.gz"
          arm_url="https://github.com/${repo}/releases/download/${tag}/podliner-linux-arm64.tar.gz"
          
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "ver=${ver}" >> "$GITHUB_OUTPUT"
          echo "x64=${x64_url}" >> "$GITHUB_OUTPUT"
          echo "arm=${arm_url}" >> "$GITHUB_OUTPUT"
      - name: Download assets and compute SHA256
        id: sums
        run: |
          set -euo pipefail
          mkdir -p /tmp/artifacts
          curl -Lf "${{ steps.rel.outputs.x64 }}" -o /tmp/artifacts/podliner-linux-x64.tar.gz
          curl -Lf "${{ steps.rel.outputs.arm }}" -o /tmp/artifacts/podliner-linux-arm64.tar.gz
          echo "x64sum=$(sha256sum /tmp/artifacts/podliner-linux-x64.tar.gz   | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "armsum=$(sha256sum /tmp/artifacts/podliner-linux-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Create unprivileged user for makepkg
        run: |
          useradd -m builder
          install -d -m 755 /tmp/aur
          chown -R builder:builder /tmp/aur

      - name: Prepare SSH for builder
        run: |
          install -d -m 700 /home/builder/.ssh
          cp /root/.ssh/aur /home/builder/.ssh/aur
          cat > /home/builder/.ssh/config <<'EOF'
          Host aur.archlinux.org
            User aur
            IdentityFile /home/builder/.ssh/aur
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
          EOF
          chown -R builder:builder /home/builder/.ssh
          chmod 600 /home/builder/.ssh/aur /home/builder/.ssh/config

      - name: Configure git as builder (+safe.directory)
        run: |
          runuser -u builder -- git config --global user.name  "${AUR_USERNAME:-podliner-bot}"
          runuser -u builder -- git config --global user.email "${AUR_EMAIL:-actions@users.noreply.github.com}"
          runuser -u builder -- git config --global --add safe.directory /tmp/aur

      - name: Clone AUR repo (as builder)
        run: |
          runuser -u builder -- bash -lc '
            GIT_SSH_COMMAND="ssh -F /home/builder/.ssh/config" \
            git clone "ssh://aur@aur.archlinux.org/${AUR_PACKAGE}.git" /tmp/aur
          '

      - name: Update PKGBUILD with version, URLs, sums (as builder)
        shell: bash
        run: |
          cat > /tmp/update-aur-pkgbuild.sh <<'SH'
          set -euo pipefail
          
          PKG=/tmp/aur/PKGBUILD
          NEWVER="${NEWVER:?}"
          REPO="${REPO:?}"
          X64SUM="${X64SUM:?}"
          ARMSUM="${ARMSUM:?}"
          
          # Capture current version/release before editing
          CURVER="$(grep -E '^pkgver=' "$PKG" | head -n1 | cut -d= -f2 || true)"
          CURREL="$(grep -E '^pkgrel=' "$PKG" | head -n1 | cut -d= -f2 || true)"
          CURREL="${CURREL:-0}"
          
          # Update pkgver
          awk -v ver="$NEWVER" '/^pkgver=/{print "pkgver=" ver; next} {print}' "$PKG" > "$PKG.tmp" && mv "$PKG.tmp" "$PKG"
          
          # Update pkgrel (bump on rebuild, reset on version change)
          if grep -qE '^pkgrel=' "$PKG"; then
            if [ "$CURVER" = "$NEWVER" ]; then NEWREL=$((CURREL+1)); else NEWREL=1; fi
            awk -v rel="$NEWREL" '/^pkgrel=/{print "pkgrel=" rel; next} {print}' "$PKG" > "$PKG.tmp" && mv "$PKG.tmp" "$PKG"
          else
            echo "pkgrel=1" >> "$PKG"
          fi
          
          # Rewrite sources to be version-dynamic (v${pkgver}) and update sums
          export REPO X64SUM ARMSUM
          cat > /tmp/rewrite.awk <<'AWK'
          BEGIN {
            pv = "$" "{pkgver}"
            repo = ENVIRON["REPO"]
            x64 = "https://github.com/" repo "/releases/download/v" pv "/podliner-linux-x64.tar.gz"
            arm = "https://github.com/" repo "/releases/download/v" pv "/podliner-linux-arm64.tar.gz"
          }
          /^source_x86_64=/      { print "source_x86_64=(\"podliner-" pv "-linux-x64.tar.gz::" x64 "\")"; next }
          /^source_aarch64=/     { print "source_aarch64=(\"podliner-" pv "-linux-arm64.tar.gz::" arm "\")"; next }
          /^sha256sums_x86_64=/  { print "sha256sums_x86_64=(\"" ENVIRON["X64SUM"] "\")"; next }
          /^sha256sums_aarch64=/ { print "sha256sums_aarch64=(\"" ENVIRON["ARMSUM"] "\")"; next }
          { print }
          AWK
          
          awk -f /tmp/rewrite.awk "$PKG" > "$PKG.tmp" && mv "$PKG.tmp" "$PKG"
          
          echo "----- PKGBUILD after rewrite -----"
          sed -n "1,200p" "$PKG"
          SH
          chmod +x /tmp/update-aur-pkgbuild.sh
          
          runuser -u builder -- env \
            NEWVER="${{ steps.rel.outputs.ver }}" \
            REPO="$GITHUB_REPOSITORY" \
            X64SUM="${{ steps.sums.outputs.x64sum }}" \
            ARMSUM="${{ steps.sums.outputs.armsum }}" \
            bash /tmp/update-aur-pkgbuild.sh
          
      - name: Generate .SRCINFO (as builder)
        run: |
          runuser -u builder -- bash -lc 'cd /tmp/aur && makepkg --printsrcinfo > .SRCINFO'

      - name: Commit and push to AUR (as builder)
        run: |
          runuser -u builder -- bash -lc '
            set -euo pipefail
            cd /tmp/aur
            git add PKGBUILD .SRCINFO
            git commit -m "${AUR_PACKAGE} ${{ steps.rel.outputs.ver }} (automated)" || echo "No changes to commit"
            GIT_SSH_COMMAND="ssh -F /home/builder/.ssh/config" git push origin HEAD:master
          '

  # --------- OPTIONAL: first-time creation of the winget package ----------
  winget-bootstrap:
    name: bootstrap winget (one-time)
    runs-on: windows-latest
    needs: publish
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.bootstrap_winget }}
    steps:
      - name: Determine version + exe URL (latest tag)
        id: meta
        shell: pwsh
        run: |
          $repo = "${{ github.repository }}"
          $hdr  = @{ Authorization = "token ${{ github.token }}" }
          $rel  = Invoke-RestMethod -Headers $hdr -Uri "https://api.github.com/repos/$repo/releases/latest"
          $tag  = $rel.tag_name
          if (-not $tag) { throw "Could not get latest release tag." }
          $ver  = $tag.TrimStart('v')
          $exe  = "https://github.com/$repo/releases/download/$tag/podliner-win-x64.exe"
          "tag=$tag"    | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$ver"| Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "exeurl=$exe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Submit to winget-pkgs (creates PR)
        uses: microsoft/winget-create@v1
        with:
          token: ${{ secrets.WINGET_TOKEN }}
          urls: |
            ${{ steps.meta.outputs.exeurl }}
          package_identifier: TimKicker.Podliner
          package_version: ${{ steps.meta.outputs.version }}
          package_name: Podliner
          publisher: TimKicker
          short_description: Terminal-based podcast player (TUI).
          license: GPLv3

  # --------- Regular winget update after each release tag ----------
  submit-to-winget:
    name: submit to winget
    runs-on: ubuntu-latest
    needs: publish
    env:
      GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
    steps:
      - name: Tag â†’ version
        id: meta
        shell: bash
        run: |
          TAG="${GITHUB_REF##*/}"; echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Winget Releaser (updates existing package)
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: TimKicker.Podliner
          version: ${{ steps.meta.outputs.version }}
          token: ${{ secrets.WINGET_TOKEN }}
          installers-regex: '\.(exe|msi|msix|appx)(bundle)?$'
          release-repository: podliner
          release-tag: ${{ github.ref_name }}
          fork-user: timkicker
