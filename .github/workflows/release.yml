name: release

permissions:
  contents: write

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    name: build linux (${{ matrix.rid }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [linux-x64, linux-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          cp LICENSE package/podliner/ 2>/dev/null || true
          cp README.md package/podliner/ 2>/dev/null || true
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  build-windows:
    name: build windows (win-x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish (self-contained)
        shell: pwsh
        run: >
          dotnet publish .\StuiPodcast.App\StuiPodcast.App.csproj
          -c Release -r win-x64
          -p:SelfContained=true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:DebugType=None
          -p:Version=${{ steps.meta.outputs.version }}
          -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }}
          -o publish\win-x64

      - name: Package zip
        shell: pwsh
        run: |
          New-Item -Type Directory package\podliner | Out-Null
          Copy-Item publish\win-x64\StuiPodcast.App.exe package\podliner\podliner.exe
          If (Test-Path LICENSE) { Copy-Item LICENSE package\podliner\ }
          If (Test-Path README.md) { Copy-Item README.md package\podliner\ }
          Compress-Archive -Path package\podliner\* -DestinationPath podliner-win-x64.zip
          New-Item -Type Directory dist | Out-Null
          Move-Item podliner-win-x64.zip dist\

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-win-x64
          path: dist/podliner-win-x64.zip

  build-macos:
    name: build macOS (${{ matrix.rid }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        rid: [osx-x64, osx-arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        shell: bash
        run: dotnet restore

      - name: Publish (self-contained)
        shell: bash
        run: |
          dotnet publish ./StuiPodcast.App/StuiPodcast.App.csproj \
            -c Release \
            -r ${{ matrix.rid }} \
            -p:SelfContained=true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -p:DebugType=None \
            -p:Version=${{ steps.meta.outputs.version }} \
            -p:AssemblyInformationalVersion=${{ steps.meta.outputs.version }} \
            -o publish/${{ matrix.rid }}

      - name: Package tar.gz
        shell: bash
        run: |
          mkdir -p dist package/podliner
          cp publish/${{ matrix.rid }}/StuiPodcast.App package/podliner/podliner
          chmod +x package/podliner/podliner
          cp LICENSE package/podliner/ 2>/dev/null || true
          cp README.md package/podliner/ 2>/dev/null || true
          tar -C package -czf dist/podliner-${{ matrix.rid }}.tar.gz podliner

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: podliner-${{ matrix.rid }}
          path: dist/podliner-${{ matrix.rid }}.tar.gz

  publish:
    name: publish release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: meta
        shell: bash
        run: |
          VER="${GITHUB_REF##*/}"
          echo "version=${VER#v}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: gathered

      - name: Gather into dist/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          find gathered -type f -name 'podliner-*' -exec cp {} dist/ \;
          cp scripts/install.ps1      dist/install.ps1
          cp scripts/install.sh       dist/install.sh
          cp scripts/install-macos.sh dist/install-macos.sh

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create/Update GitHub Release (robust w/ retry)
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.ref_name }}
          VER: ${{ steps.meta.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail
          PRE=""
          if [[ "$TAG" == *-rc* || "$TAG" == *-beta* ]]; then
            PRE="--prerelease"
          fi

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "podliner ${VER}" \
              --generate-notes $PRE
          fi

          upload() {
            gh release upload "$TAG" \
              dist/podliner-linux-x64.tar.gz \
              dist/podliner-linux-arm64.tar.gz \
              dist/podliner-osx-x64.tar.gz \
              dist/podliner-osx-arm64.tar.gz \
              dist/podliner-win-x64.zip \
              dist/install.sh \
              dist/install.ps1 \
              dist/install-macos.sh \
              dist/SHA256SUMS \
              --clobber
          }

          for i in 1 2 3; do
            if upload; then
              echo "Assets uploaded."
              exit 0
            fi
            echo "Release upload failed (attempt $i). Retrying..."
            sleep $((5 * i))
          done

          echo "Release upload failed after retries." >&2
          exit 1

  aur_publish:
    name: Publish AUR (podliner-bin)
    needs: publish
    runs-on: ubuntu-latest
    container:
      image: archlinux:base
    env:
      AUR_PACKAGE: podliner-bin
      AUR_EMAIL: ${{ secrets.AUR_EMAIL }}
      AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
      AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
    steps:
      - name: Install tooling
        run: |
          pacman -Sy --noconfirm git base-devel curl jq pacman-contrib openssh
          git config --global user.name  "${AUR_USERNAME:-podliner-bot}"
          git config --global user.email "${AUR_EMAIL:-actions@users.noreply.github.com}"
          ssh -V

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if [ -z "${AUR_SSH_PRIVATE_KEY}" ]; then
            echo "AUR_SSH_PRIVATE_KEY is empty (missing secret?)" >&2
            exit 1
          fi
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat <<EOF > ~/.ssh/config
          Host aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/aur
            IdentitiesOnly yes
            StrictHostKeyChecking accept-new
          EOF
          chmod 600 ~/.ssh/config

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read release info (robust tag detection)
        id: rel
        env:
          GH_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "$TAG" =~ ^v[0-9] ]]; then
            TAG=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" \
                   "https://api.github.com/repos/${GH_REPO}/releases/latest" | jq -r .tag_name)
          fi
          if [[ -z "$TAG" || "$TAG" == "null" ]]; then
            echo "Could not determine release tag"; exit 1
          fi

          VER="${TAG#v}"
          API="https://api.github.com/repos/${GH_REPO}/releases/tags/${TAG}"

          X64=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" "$API" | jq -r '.assets[] | select(.name=="podliner-linux-x64.tar.gz")   | .browser_download_url')
          ARM=$(curl -sSL -H "Authorization: Bearer $GITHUB_TOKEN" "$API" | jq -r '.assets[] | select(.name=="podliner-linux-arm64.tar.gz") | .browser_download_url')

          if [[ -z "$X64" || -z "$ARM" ]]; then
            echo "Required assets not found (podliner-linux-*.tar.gz)"; exit 1
          fi

          echo "ver=$VER"  >> $GITHUB_OUTPUT
          echo "x64=$X64" >> $GITHUB_OUTPUT
          echo "arm=$ARM" >> $GITHUB_OUTPUT

      - name: Download assets and compute SHA256
        id: sums
        run: |
          mkdir -p /tmp/artifacts
          curl -L "${{ steps.rel.outputs.x64 }}" -o /tmp/artifacts/podliner-linux-x64.tar.gz
          curl -L "${{ steps.rel.outputs.arm }}" -o /tmp/artifacts/podliner-linux-arm64.tar.gz
          echo "x64sum=$(sha256sum /tmp/artifacts/podliner-linux-x64.tar.gz   | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "armsum=$(sha256sum /tmp/artifacts/podliner-linux-arm64.tar.gz | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Clone AUR repo
        env:
          GIT_SSH_COMMAND: ssh -F ~/.ssh/config
        run: |
          git clone "ssh://aur@aur.archlinux.org/${AUR_PACKAGE}.git" /tmp/aur

      - name: Update PKGBUILD with version, URLs, sums
        run: |
          cp packaging/aur/${AUR_PACKAGE}/PKGBUILD /tmp/aur/PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=${{ steps.rel.outputs.ver }}/" /tmp/aur/PKGBUILD
          sed -i "s|releases/download/v.*/podliner-linux-x64.tar.gz|${{ steps.rel.outputs.x64 }}|" /tmp/aur/PKGBUILD
          sed -i "s|releases/download/v.*/podliner-linux-arm64.tar.gz|${{ steps.rel.outputs.arm }}|" /tmp/aur/PKGBUILD
          sed -i "s/^sha256sums_x86_64=.*/sha256sums_x86_64=('${{ steps.sums.outputs.x64sum }}')/" /tmp/aur/PKGBUILD
          sed -i "s/^sha256sums_aarch64=.*/sha256sums_aarch64=('${{ steps.sums.outputs.armsum }}')/" /tmp/aur/PKGBUILD

      - name: Generate .SRCINFO
        working-directory: /tmp/aur
        run: makepkg --printsrcinfo > .SRCINFO

      - name: Commit and push to AUR
        working-directory: /tmp/aur
        env:
          GIT_SSH_COMMAND: ssh -F ~/.ssh/config
        run: |
          git add PKGBUILD .SRCINFO
          git commit -m "${{ env.AUR_PACKAGE }} ${{ steps.rel.outputs.ver }} (automated)" || echo "No changes to commit"
          git push origin HEAD:master
